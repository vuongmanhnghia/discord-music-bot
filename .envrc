# Nếu có Nix + flake.nix → vào dev shell Nix (nhanh, có cache)
if command -v nix >/dev/null 2>&1 && [ -f flake.nix ]; then
  use flake
else
  # Fallback cho Ubuntu thuần (không Nix)
  VENV_DIR="./venv"
  export PIP_DISABLE_PIP_VERSION_CHECK=1
  export PIP_NO_INPUT=1

  if [ ! -d "$VENV_DIR" ]; then
    echo "Creating virtualenv in $VENV_DIR..."
    python3 -m venv "$VENV_DIR"
  fi

  . "$VENV_DIR/bin/activate"

  python -m pip install -U pip setuptools wheel
  if [ -f requirements.txt ]; then
    python -m pip install -r requirements.txt
  fi

  # Nhắc nhở system deps cần có trên Ubuntu
  for bin in ffmpeg; do
    command -v "$bin" >/dev/null 2>&1 || echo "Hint: install $bin (e.g., sudo apt install ffmpeg)"
  done
  # libopus/libsodium là thư viện hệ thống → cần cài qua apt chứ không phải pip
  # sudo apt install -y libopus0 libopus-dev libsodium23 libsodium-dev pkg-config
fi